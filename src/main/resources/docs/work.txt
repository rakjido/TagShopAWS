use tagshop;

INSERT INTO PRODUCTS(TITLE, DESCRIPTION, PRICE, PHOTOFILE, SMALLCATEGORYCODE, CREATEDATE, UPDATEDATE, SHOPID)
VALUES('나그랑티셔츠','시원한 나그랑티셔츠', 20000, 'TTT.JPG', '100100100', NOW(), NOW(), 'SHOP');


SELECT * from products;


COMMIT;

INSERT INTO PRODUCTITEM(PRODUCTNAME, UNITPRICE, PRODUCTID)
VALUES('나그랑 줄무늬티셔츠', 28000, 2);


select * from productitem;

INSERT INTO OPTIONS(OPTIONTYPE, OPTIONCODE, PRODUCTITEMID)
VALUES('SIZE','L', 1);

INSERT INTO OPTIONS(OPTIONTYPE, OPTIONCODE, PRODUCTITEMID)
VALUES('SIZE','XL', 1);

INSERT INTO OPTIONS(OPTIONTYPE, OPTIONCODE, PRODUCTITEMID)
VALUES('COLOR','BLUE', 1);

INSERT INTO OPTIONS(OPTIONTYPE, OPTIONCODE, PRODUCTITEMID)
VALUES('COLOR','BLACK', 1);


select * from options;
COMMIT;

########################################
SELECT * FROM BASKETS B JOIN BUYITEMS I
ON B.BASKETID = I.BASKETID
WHERE B.USERID='ZOZO'
AND I.ORDERSTATUSCODE='OR01';


INSERT INTO BASKETS(DELIVERYFEE, USEDPOINT, PAYTYPECODE, CREATEDATE, UPDATEDATE, USERID)
VALUES(2500, 0,  'CRDT', NOW(), NOW(), 'ZOZO');

select * from baskets;

INSERT INTO BUYITEMS(UNITPRICE, QUANTITY, ORDERSTATUSCODE, BASKETID, PRODUCTITEMID)
VALUES(28000, 2, 'OR01', 1,1);

select * from buyitems;


INSERT INTO SELECTEDOPTION(OPTIONTYPE, OPTIONCODE, BUYITEMSID)
VALUES('SIZE','XL', 1);

INSERT INTO SELECTEDOPTION(OPTIONTYPE, OPTIONCODE, BUYITEMSID)
VALUES('COLOR','BLACK', 1);


select * from selectedoption;

SELECT I.BASKETID, I.BUYITEMSID, P.PRODUCTNAME, I.QUANTITY, (I.QUANTITY*I.UNITPRICE) AS TOTALPRICE 
FROM BUYITEMS I JOIN BASKETS B ON I.BASKETID = B.BASKETID
				JOIN PRODUCTITEM P ON I.PRODUCTITEMID = P.PRODUCTITEMID
WHERE B.USERID='ZOZO'
AND I.ORDERSTATUSCODE='OR01';

SELECT I.BUYITEMSID, O.OPTIONTYPE, O.OPTIONCODE 
FROM BUYITEMS I JOIN BASKETS B ON I.BASKETID = B.BASKETID
				JOIN SELECTEDOPTION O ON I.BUYITEMSID = O.BUYITEMSID
WHERE B.USERID='ZOZO'
AND I.ORDERSTATUSCODE='OR01';


select * from productitem;

###########################

DELIMITER //
DROP PROCEDURE IF EXISTS CHECK_INSERT_BASKET //
CREATE PROCEDURE CHECK_INSERT_BASKET (
	IN in_delivery_fee double,
    IN in_used_point double,
    IN in_userid varchar(50),
    IN in_unit_price double,
    IN in_quantity double,
    IN in_order_status_code varchar(10),
    IN in_product_item_id bigint
)
BEGIN
	DECLARE cnt int(11);
    DECLARE basketid bigint;
    
    SET cnt = (
				SELECT COUNT(*) AS CNT FROM BASKETS B JOIN BUYITEMS I
				ON B.BASKETID = I.BASKETID
				WHERE B.USERID = in_userid
				AND I.ORDERSTATUSCODE = 'OR01'
    );
    
    IF cnt > 0 THEN
        SET basketid = (
				SELECT B.BASKETID FROM BASKETS B JOIN BUYITEMS I
				ON B.BASKETID = I.BASKETID
				WHERE B.USERID = in_userid
				AND I.ORDERSTATUSCODE = 'OR01'
		);

		INSERT INTO BUYITEMS(UNITPRICE, QUANTITY, ORDERSTATUSCODE, BASKETID, PRODUCTITEMID)
		VALUES(in_unit_price, in_quantity, in_order_status_code, basketid, in_product_item_id);
        
		COMMIT;
    ELSEIF cnt = 0  THEN
		INSERT INTO BASKETS(DELIVERYFEE, USEDPOINT, PAYTYPECODE, CREATEDATE, UPDATEDATE, USERID)
		VALUES(in_delivery_fee, in_used_point,  'CRDT', NOW(), NOW(), in_userid);

		INSERT INTO BUYITEMS(UNITPRICE, QUANTITY, ORDERSTATUSCODE, BASKETID, PRODUCTITEMID)
		VALUES(in_unit_price, in_quantity, in_order_status_code, basketid, in_product_item_id);
        
		COMMIT;
    END IF;
    
    
END//
DELIMITER ;

COMMIT;

SHOW PROCEDURE STATUS;

SELECT COUNT(*) AS CNT FROM BASKETS B JOIN BUYITEMS I
ON B.BASKETID = I.BASKETID
WHERE B.USERID='ZOZO'
AND I.ORDERSTATUSCODE='OR01';

SELECT B.BASKETID FROM BASKETS B JOIN BUYITEMS I
ON B.BASKETID = I.BASKETID
WHERE B.USERID='ZOZO'
AND I.ORDERSTATUSCODE='OR01';


INSERT INTO BASKETS(DELIVERYFEE, USEDPOINT, PAYTYPECODE, CREATEDATE, UPDATEDATE, USERID)
VALUES(2500, 0,  'CRDT', NOW(), NOW(), 'ZOZO');

INSERT INTO BUYITEMS(UNITPRICE, QUANTITY, ORDERSTATUSCODE, BASKETID, PRODUCTITEMID)
VALUES(28000, 2, 'OR01', 1,1);


CALL CHECK_INSERT_BASKET(2500, 0, 'ZOZO', 25000, 1, 'OR01',1);

SELECT * FROM BASKETS;
SELECT * FROM BUYITEMS;
 
